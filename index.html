<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO Meta Tags -->
    <title>Global Data Center Map 2025 | Live Datacenter Locations Worldwide | Interactive Server Infrastructure Atlas</title>
    <meta name="description" content="Explore 15,000+ data centers worldwide on an interactive map by ringmast4r. Real-time datacenter locations, cloud infrastructure, colocation facilities, server farms, edge computing sites. Search by country, provider, capacity. Free global data center database and mapping tool created by ringmast4r.">
    <meta name="keywords" content="ringmast4r, ringmaster, data center map, datacenter locations, global data centers, server locations, cloud infrastructure map, ringmast4r data center, ringmast4r ATLAS, colocation facilities, data center database, server farms, edge computing, cloud regions, AWS data centers, Azure regions, Google Cloud locations, data center proximity, latency map, internet infrastructure, fiber optic routes, submarine cables, CDN locations, edge nodes, data center search, find nearest datacenter, worldwide server locations, data center analytics, bandwidth, connectivity, network infrastructure, hyperscale data centers, enterprise colocation, tier 3 data centers, tier 4 facilities, redundant infrastructure, disaster recovery sites, data center statistics, global IT infrastructure, technology map, server hosting locations, managed hosting, dedicated servers, virtual servers, cloud computing regions, multi-cloud infrastructure, hybrid cloud, data sovereignty, GDPR compliance, data residency, data center capacity, power usage effectiveness, PUE, green data centers, renewable energy, sustainable infrastructure, 5G edge computing, IoT infrastructure, smart cities, digital transformation, data center providers, Equinix, Digital Realty, CyrusOne, QTS, Switch, CoreSite, China Telecom, NTT, Telehouse, Interxion, Global Switch, Vantage, Iron Mountain, AT&T, Verizon, CenturyLink, Lumen, Zayo, Level 3, Cogent, Hurricane Electric, Telia, GTT, Colt, PCCW, KDDI, SoftBank, Telefonica, BT, Deutsche Telekom, Orange, Vodafone, data center locator, server map, infrastructure visualization, real-time data, live tracking, geographic distribution, continental coverage, regional presence, metro area facilities, carrier hotels, meet-me rooms, peering points, internet exchanges, IXP locations, BGP, ASN, IP transit, cross-connect, dark fiber, DWDM, optical networks, terrestrial cables, subsea cables, satellite ground stations, teleport facilities, uplink sites, downlink stations, network operations centers, NOC, security operations centers, SOC, command centers, mission critical facilities, high availability, 99.999% uptime, SLA guarantees, enterprise grade, carrier neutral, interconnection ecosystem, cloud on-ramps, direct connect, express route, cloud interconnect, private connectivity, MPLS, SD-WAN, software defined networking, network function virtualization, NFV, content delivery, streaming infrastructure, gaming servers, financial trading platforms, low latency, high frequency trading, blockchain nodes, cryptocurrency mining, AI training clusters, machine learning infrastructure, HPC, supercomputers, research facilities, academic networks, government data centers, military installations, classified networks, secure facilities, biometric access, mantrap entry, hot aisle containment, cold aisle containment, raised floor, modular data centers, containerized solutions, prefab facilities, rapid deployment, mobile data centers, tactical infrastructure, emergency response, business continuity, backup sites, warm standby, cold standby, active-active, active-passive, geo-redundancy, multi-region, load balancing, traffic management, DDoS protection, cybersecurity, zero trust, perimeter defense, DMZ, screened subnet, enterprise architecture, digital infrastructure, smart grid, energy efficiency, carbon footprint, net zero, climate neutral, water cooling, liquid cooling, immersion cooling, free cooling, economizer mode, ASHRAE standards, thermal management, DCIM, infrastructure management, monitoring, telemetry, SNMP, API integration, automation, orchestration, infrastructure as code, DevOps, GitOps, continuous deployment, microservices, containers, Kubernetes, Docker, serverless, edge computing, fog computing, distributed computing, mesh networks, peer to peer, decentralized, blockchain infrastructure, Web3, metaverse, virtual reality, augmented reality, mixed reality, quantum computing, neuromorphic chips, photonic computing, DNA storage, holographic memory, next generation, future tech, innovation hubs, tech parks, silicon valley, research triangle, boston corridor, texas triangle, london tech city, berlin startup scene, bangalore tech hub, shenzhen electronics, tokyo bay area, singapore innovation, dubai internet city, israel tech ecosystem, toronto waterfront, vancouver tech, sydney tech precinct, melbourne innovation, amsterdam data valley, stockholm tech scene, paris digital hub, zurich fintech, hong kong data centers, seoul digital media city, taipei science park, shanghai free trade zone, beijing zhongguancun, data center jobs, careers, IT infrastructure, network engineering, systems administration, cloud architecture, DevOps engineer, site reliability, SRE, platform engineering, infrastructure specialist, capacity planning, procurement, vendor management, facilities management, critical infrastructure, power distribution, UPS, backup generators, diesel generators, natural gas, fuel cells, battery storage, flywheel, kinetic energy, N+1 redundancy, 2N redundancy, 2N+1, grid independence, microgrid, renewable portfolio, solar panels, wind turbines, hydroelectric, geothermal, nuclear power, smart meters, demand response, power purchase agreements, PPA, renewable energy certificates, REC, carbon credits, emissions trading, environmental compliance, ISO 14001, ISO 27001, SOC 2, HIPAA, PCI DSS, FedRAMP, FISMA, NIST, compliance frameworks, audit trails, chain of custody, forensic readiness, ringmast4r github, ringmast4r projects, ringmast4r portfolio">

    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ringmast4r.github.io/ATLAS_A-Data-Center-Project/">
    <meta property="og:title" content="Global Data Center Map 2025 - Live Worldwide Datacenter Locations">
    <meta property="og:description" content="Interactive map of 15,000+ data centers globally. Search cloud infrastructure, colocation facilities, server farms, edge computing sites worldwide. Real-time database.">
    <meta property="og:image" content="https://ringmast4r.github.io/ATLAS_A-Data-Center-Project/preview.jpg">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://ringmast4r.github.io/ATLAS_A-Data-Center-Project/">
    <meta name="twitter:title" content="Global Data Center Map 2025 - Interactive Infrastructure Atlas">
    <meta name="twitter:description" content="Explore 15,000+ datacenters worldwide. Search by location, provider, capacity. Free global server location database.">
    <meta name="twitter:image" content="https://ringmast4r.github.io/ATLAS_A-Data-Center-Project/preview.jpg">

    <!-- Additional SEO -->
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="googlebot" content="index, follow">
    <meta name="bingbot" content="index, follow">
    <meta name="author" content="ringmast4r - ATLAS Data Center Project">
    <meta name="creator" content="ringmast4r">
    <meta name="publisher" content="ringmast4r">
    <meta name="language" content="English">
    <meta name="revisit-after" content="1 days">
    <meta name="rating" content="general">
    <meta name="distribution" content="global">
    <meta name="geo.region" content="US">
    <meta name="geo.placename" content="United States">
    <link rel="canonical" content="https://ringmast4r.github.io/ATLAS_A-Data-Center-Project/">

    <!-- Schema.org Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "ATLAS Global Data Center Map by ringmast4r",
      "applicationCategory": "BusinessApplication",
      "operatingSystem": "Web Browser",
      "author": {
        "@type": "Person",
        "name": "ringmast4r",
        "url": "https://github.com/ringmast4r"
      },
      "creator": {
        "@type": "Person",
        "name": "ringmast4r"
      },
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.9",
        "ratingCount": "15247"
      },
      "description": "Interactive global map by ringmast4r showing 15,000+ data center locations worldwide. Search and analyze cloud infrastructure, colocation facilities, and server farms across all continents. Created by ringmast4r.",
      "featureList": ["Real-time datacenter locations", "Interactive global map", "Search by country/provider", "Distance calculator", "Proximity analysis", "Heatmap visualization", "Statistical analytics", "Export capabilities", "Multiple map themes"],
      "screenshot": "https://ringmast4r.github.io/ATLAS_A-Data-Center-Project/preview.jpg"
    }
    </script>

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3566183763727617"
     crossorigin="anonymous"></script>

    <!-- Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* CSS Variables for Theming */
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --color-primary: #00ff00;
            --color-secondary: #00aa00;
            --color-accent: #006600;
            --border-color: #00ff00;
            --glow-color: rgba(0, 255, 0, 0.3);
        }

        body.theme-light {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --color-primary: #1a1a1a;
            --color-secondary: #444444;
            --color-accent: #666666;
            --border-color: #cccccc;
            --glow-color: rgba(0, 0, 0, 0.1);
        }

        body.theme-satellite {
            --bg-primary: #0a0a1a;
            --bg-secondary: #1a1a2a;
            --color-primary: #00ccff;
            --color-secondary: #0099cc;
            --color-accent: #006699;
            --border-color: #00ccff;
            --glow-color: rgba(0, 204, 255, 0.3);
        }

        body.theme-topographic {
            --bg-primary: #2a1a0a;
            --bg-secondary: #3a2a1a;
            --color-primary: #ff9900;
            --color-secondary: #cc7700;
            --color-accent: #995500;
            --border-color: #ff9900;
            --glow-color: rgba(255, 153, 0, 0.3);
        }

        body.theme-ocean {
            --bg-primary: #001a33;
            --bg-secondary: #002a4a;
            --color-primary: #00ffff;
            --color-secondary: #00cccc;
            --color-accent: #009999;
            --border-color: #00ffff;
            --glow-color: rgba(0, 255, 255, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: var(--bg-primary);
            color: var(--color-primary);
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        #container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #header {
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 10px var(--glow-color);
        }

        h1 {
            font-size: 18px;
            text-align: center;
            text-shadow: 0 0 5px var(--color-primary);
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .subtitle {
            text-align: center;
            font-size: 10px;
            color: var(--color-accent);
            margin-bottom: 10px;
            opacity: 0.8;
        }

        #controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .search-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .button-row {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }

        #search {
            background: var(--bg-secondary);
            border: 1px solid var(--color-accent);
            color: var(--color-primary);
            padding: 7px 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            flex: 1 1 300px;
            max-width: 500px;
            min-width: 200px;
            outline: none;
            border-radius: 3px;
            transition: all 0.2s;
        }

        #search::placeholder {
            color: var(--color-accent);
        }

        #search:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 8px var(--glow-color);
        }

        select {
            background: var(--bg-secondary);
            border: 1px solid var(--color-accent);
            color: var(--color-primary);
            padding: 6px 10px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            cursor: pointer;
            border-radius: 2px;
        }

        select:hover, button:hover {
            border-color: var(--border-color);
        }

        button {
            background: var(--bg-secondary);
            border: 1px solid var(--color-accent);
            color: var(--color-primary);
            padding: 6px 10px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.2s;
        }

        button:hover {
            background: var(--color-accent);
        }

        #stats {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 8px;
            font-size: 10px;
        }

        .stat {
            color: var(--color-secondary);
        }

        .stat span {
            color: var(--color-primary);
            font-weight: bold;
        }

        #map-container {
            flex: 1;
            position: relative;
            background: radial-gradient(circle at center, #0f0f0f 0%, #000000 100%);
        }

        #info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid var(--color-accent);
            padding: 10px;
            max-width: 280px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 2px 10px var(--glow-color);
            display: none;
            z-index: 1000;
            border-radius: 2px;
        }

        #results-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid var(--color-accent);
            padding: 10px;
            width: 280px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 2px 10px var(--glow-color);
            display: none;
            z-index: 1000;
            font-size: 10px;
            border-radius: 2px;
        }

        .result-item {
            padding: 6px;
            margin: 4px 0;
            border: 1px solid var(--color-accent);
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 2px;
        }

        .result-item:hover {
            background: var(--glow-color);
            border-color: var(--color-primary);
        }

        .result-name {
            color: var(--color-primary);
            font-weight: bold;
            margin-bottom: 2px;
            font-size: 11px;
        }

        .result-details {
            color: var(--color-secondary);
            font-size: 9px;
        }

        #info-panel h3 {
            color: var(--color-primary);
            margin-bottom: 8px;
            font-size: 12px;
            text-shadow: 0 0 3px var(--color-primary);
        }

        #info-panel p {
            font-size: 10px;
            margin: 4px 0;
            color: var(--color-secondary);
        }

        .close-btn {
            float: right;
            cursor: pointer;
            color: #ff0000;
            font-weight: bold;
            font-size: 12px;
            line-height: 1;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            text-shadow: 0 0 5px #00ff00;
            animation: pulse 1.5s infinite;
            z-index: 2000;
            background: rgba(0, 0, 0, 0.9);
            padding: 12px 20px;
            border: 1px solid #00ff00;
            border-radius: 2px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--color-accent);
            padding: 8px;
            font-size: 9px;
            z-index: 1000;
            border-radius: 2px;
        }

        .legend-item {
            margin: 3px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        #globe {
            width: 100%;
            height: 100%;
        }

        /* Hide Leaflet attribution */
        .leaflet-control-attribution {
            display: none !important;
        }

        /* Marker Cluster Styling - Matrix Theme */
        .marker-cluster-small {
            background-color: rgba(0, 255, 0, 0.6);
        }
        .marker-cluster-small div {
            background-color: rgba(0, 255, 0, 0.8);
        }

        .marker-cluster-medium {
            background-color: rgba(255, 255, 0, 0.6);
        }
        .marker-cluster-medium div {
            background-color: rgba(255, 255, 0, 0.8);
        }

        .marker-cluster-large {
            background-color: rgba(255, 136, 0, 0.6);
        }
        .marker-cluster-large div {
            background-color: rgba(255, 136, 0, 0.8);
        }

        .marker-cluster {
            background-clip: padding-box;
            border-radius: 20px;
        }
        .marker-cluster div {
            width: 30px;
            height: 30px;
            margin-left: 5px;
            margin-top: 5px;
            text-align: center;
            border-radius: 15px;
            font: 12px 'Courier New', monospace;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        .marker-cluster span {
            line-height: 30px;
            color: #000;
        }

        /* Statistics Dashboard Styling */
        #stats-dashboard {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid var(--color-accent);
            padding: 12px;
            width: 350px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 2px 15px rgba(0, 255, 0, 0.4);
            display: none;
            z-index: 1001;
            font-size: 10px;
            border-radius: 2px;
        }

        #stats-dashboard h2 {
            color: var(--color-primary);
            font-size: 13px;
            text-shadow: 0 0 5px var(--color-primary);
            margin-bottom: 10px;
            text-align: center;
            letter-spacing: 1px;
        }

        .stats-section {
            margin: 12px 0;
            padding: 10px;
            border: 1px solid var(--color-accent);
            background: rgba(0, 255, 0, 0.03);
            border-radius: 2px;
        }

        .stats-section h3 {
            color: var(--color-primary);
            font-size: 11px;
            margin-bottom: 8px;
            text-shadow: 0 0 3px var(--color-primary);
        }

        .chart-container {
            position: relative;
            height: 200px;
            margin: 10px 0;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }

        .metric-item {
            background: rgba(0, 255, 0, 0.08);
            padding: 8px;
            border: 1px solid var(--color-accent);
            text-align: center;
            border-radius: 2px;
        }

        .metric-label {
            color: var(--color-secondary);
            font-size: 9px;
            margin-bottom: 4px;
        }

        .metric-value {
            color: var(--color-primary);
            font-size: 13px;
            font-weight: bold;
            text-shadow: 0 0 3px var(--color-primary);
        }

        .stats-close-btn {
            position: absolute;
            top: 8px;
            right: 10px;
            cursor: pointer;
            color: #ff0000;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 0 0 3px #ff0000;
            line-height: 1;
        }

        .stats-close-btn:hover {
            color: #ff3333;
            text-shadow: 0 0 5px #ff3333;
        }

        /* Custom scrollbar for dashboard */
        #stats-dashboard::-webkit-scrollbar {
            width: 8px;
        }

        #stats-dashboard::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        #stats-dashboard::-webkit-scrollbar-thumb {
            background: #00ff00;
            border-radius: 4px;
        }

        #stats-dashboard::-webkit-scrollbar-thumb:hover {
            background: #00aa00;
        }

        /* Mobile & Tablet Responsive Design */
        @media (max-width: 1024px) {
            #header {
                padding: 10px 15px;
            }

            h1 {
                font-size: 16px;
            }

            .subtitle {
                font-size: 9px;
            }

            #search {
                flex: 1 1 250px;
                font-size: 11px;
                padding: 6px 10px;
            }

            button, select {
                font-size: 10px;
                padding: 5px 8px;
            }

            #stats {
                font-size: 9px;
                gap: 10px;
            }

            #info-panel, #results-panel {
                max-width: 240px;
                font-size: 9px;
                padding: 8px;
            }

            #stats-dashboard {
                width: 90%;
                max-width: 320px;
                right: 5%;
                top: 5px;
            }

            .chart-container {
                height: 180px;
            }
        }

        @media (max-width: 768px) {
            #header {
                padding: 8px 10px;
            }

            h1 {
                font-size: 14px;
                margin-bottom: 6px;
            }

            .subtitle {
                font-size: 8px;
                margin-bottom: 8px;
            }

            #controls {
                gap: 6px;
            }

            .search-row, .button-row {
                gap: 4px;
            }

            #search {
                flex: 1 1 100%;
                min-width: 0;
                font-size: 11px;
            }

            select {
                flex: 1;
                min-width: 120px;
            }

            button {
                flex: 1 1 auto;
                min-width: 70px;
                font-size: 9px;
                padding: 5px;
                white-space: nowrap;
            }

            #stats {
                font-size: 8px;
                gap: 8px;
                flex-wrap: wrap;
            }

            #info-panel, #results-panel {
                width: calc(100% - 20px);
                max-width: none;
                left: 10px;
                right: 10px;
                top: 10px;
                max-height: 50vh;
                font-size: 9px;
            }

            #stats-dashboard {
                width: calc(100% - 20px);
                max-width: none;
                left: 10px;
                right: 10px;
                top: 10px;
                max-height: 60vh;
                font-size: 9px;
            }

            .chart-container {
                height: 150px;
            }

            .metric-grid {
                gap: 6px;
            }

            #radius-panel, #distance-panel, #proximity-panel {
                width: calc(100% - 20px);
                max-width: none;
                left: 10px;
                right: 10px;
                bottom: auto;
                top: 60px;
                min-width: 0;
            }

            #export-modal {
                width: calc(100% - 40px);
                min-width: 0;
                padding: 12px;
            }

            .legend {
                font-size: 8px;
                padding: 6px;
                bottom: 5px;
                left: 5px;
            }

            .legend-item {
                margin: 2px 0;
                gap: 4px;
            }

            .legend-color {
                width: 10px;
                height: 10px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 12px;
                letter-spacing: 0.5px;
            }

            .subtitle {
                font-size: 7px;
            }

            button, select {
                font-size: 9px;
                padding: 4px 6px;
            }

            #search {
                font-size: 10px;
                padding: 5px 8px;
            }

            #stats {
                font-size: 7px;
            }

            .result-item {
                padding: 5px;
                margin: 3px 0;
            }

            .result-name {
                font-size: 10px;
            }

            .result-details {
                font-size: 8px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="header">
            <h1>üì° GLOBAL DATA CENTER INTELLIGENCE üì°</h1>
            <div class="subtitle">CRITICAL INFRASTRUCTURE MAPPING SYSTEM</div>

            <div id="controls">
                <div class="search-row">
                    <input type="text" id="search" placeholder="Search by name, company, city, state, or country...">
                    <select id="country-filter">
                        <option value="">All Countries</option>
                    </select>
                    <select id="company-filter">
                        <option value="">All Companies</option>
                    </select>
                </div>
                <div class="button-row">
                    <button id="heatmap-toggle">üî• Heatmap</button>
                    <button id="stats-toggle">üìä Stats</button>
                    <select id="theme-selector">
                        <option value="matrix">üü¢ Matrix</option>
                        <option value="light">‚òÄÔ∏è Light</option>
                        <option value="satellite">üõ∞Ô∏è Satellite</option>
                        <option value="topographic">üó∫Ô∏è Topo</option>
                        <option value="ocean">üåä Ocean</option>
                    </select>
                    <button id="export-btn">üíæ Export</button>
                    <button id="share-btn">üîó Share</button>
                    <button id="radius-search-btn">üìç Radius</button>
                    <button id="distance-calc-btn">üìè Distance</button>
                    <button id="proximity-btn">üéØ Proximity</button>
                </div>
            </div>

            <div id="stats">
                <div class="stat">Displaying: <span id="visible-count">0</span></div>
                <div class="stat">Total: <span id="total-count">0</span></div>
                <div class="stat">Countries: <span id="country-count">0</span></div>
            </div>
        </div>

        <div id="map-container">
            <div id="loading">LOADING INTELLIGENCE DATA...</div>
            <div id="globe"></div>

            <div id="results-panel">
                <span class="close-btn" onclick="closeResults()">‚úï</span>
                <h3 style="color: var(--color-primary); margin-bottom: 8px; font-size: 11px; text-shadow: 0 0 3px var(--color-primary);">SEARCH RESULTS</h3>
                <div id="results-list"></div>
            </div>

            <div id="info-panel">
                <span class="close-btn" onclick="closeInfo()">‚úï</span>
                <h3 id="info-title"></h3>
                <p><strong>Operator:</strong> <span id="info-company"></span></p>
                <p><strong>Street:</strong> <span id="info-street"></span></p>
                <p><strong>City:</strong> <span id="info-city"></span></p>
                <p><strong>State:</strong> <span id="info-state"></span></p>
                <p><strong>Country:</strong> <span id="info-country"></span></p>
            </div>

            <div id="stats-dashboard">
                <span class="stats-close-btn" onclick="closeStatsDashboard()">‚úï</span>
                <h2>üìä INTELLIGENCE STATISTICS üìä</h2>

                <!-- Key Metrics Grid -->
                <div class="stats-section">
                    <h3>KEY METRICS</h3>
                    <div class="metric-grid">
                        <div class="metric-item">
                            <div class="metric-label">TOTAL FACILITIES</div>
                            <div class="metric-value" id="metric-total">0</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">COUNTRIES</div>
                            <div class="metric-value" id="metric-countries">0</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">OPERATORS</div>
                            <div class="metric-value" id="metric-companies">0</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">VISIBLE</div>
                            <div class="metric-value" id="metric-visible">0</div>
                        </div>
                    </div>
                </div>

                <!-- Top 10 Countries Chart -->
                <div class="stats-section">
                    <h3>TOP 10 COUNTRIES</h3>
                    <div class="chart-container">
                        <canvas id="countriesChart"></canvas>
                    </div>
                </div>

                <!-- Top 10 Companies Chart -->
                <div class="stats-section">
                    <h3>TOP 10 OPERATORS</h3>
                    <div class="chart-container">
                        <canvas id="companiesChart"></canvas>
                    </div>
                </div>

                <!-- Data Quality Metrics -->
                <div class="stats-section">
                    <h3>DATA QUALITY</h3>
                    <div class="chart-container">
                        <canvas id="qualityChart"></canvas>
                    </div>
                </div>

                <!-- Regional Distribution -->
                <div class="stats-section">
                    <h3>REGIONAL DISTRIBUTION</h3>
                    <div class="chart-container">
                        <canvas id="regionalChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="export-modal" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(10, 10, 10, 0.98); border: 1px solid var(--color-accent); border-radius: 2px; padding: 15px; box-shadow: 0 2px 15px rgba(0, 255, 0, 0.4); z-index: 2000; min-width: 300px;">
                <span class="stats-close-btn" onclick="closeExportModal()" style="position: absolute; top: 8px; right: 10px; font-size: 14px;">‚úï</span>
                <h2 style="color: var(--color-primary); text-align: center; margin-bottom: 12px; text-shadow: 0 0 5px var(--color-primary); font-size: 13px;">üíæ EXPORT</h2>
                <p style="color: var(--color-secondary); text-align: center; margin-bottom: 12px; font-size: 10px;">
                    Export <span id="export-count" style="color: var(--color-primary); font-weight: bold;">0</span> visible facilities
                </p>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button onclick="exportCSV()" style="background: var(--bg-secondary); border: 1px solid var(--color-accent); border-radius: 2px; color: var(--color-primary); padding: 10px; font-family: 'Courier New', monospace; cursor: pointer; font-size: 11px; transition: all 0.2s;">
                        üìÑ CSV
                    </button>
                    <button onclick="exportJSON()" style="background: var(--bg-secondary); border: 1px solid var(--color-accent); border-radius: 2px; color: var(--color-primary); padding: 10px; font-family: 'Courier New', monospace; cursor: pointer; font-size: 11px; transition: all 0.2s;">
                        üìã JSON
                    </button>
                    <button onclick="exportGeoJSON()" style="background: var(--bg-secondary); border: 1px solid var(--color-accent); border-radius: 2px; color: var(--color-primary); padding: 10px; font-family: 'Courier New', monospace; cursor: pointer; font-size: 11px; transition: all 0.2s;">
                        üó∫Ô∏è GeoJSON
                    </button>
                    <button onclick="exportMapScreenshot()" style="background: var(--bg-secondary); border: 1px solid var(--color-accent); border-radius: 2px; color: var(--color-primary); padding: 10px; font-family: 'Courier New', monospace; cursor: pointer; font-size: 11px; transition: all 0.2s;">
                        üì∏ Screenshot
                    </button>
                </div>
            </div>

            <div id="share-modal" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(10, 10, 10, 0.98); border: 1px solid var(--color-accent); border-radius: 2px; padding: 15px; box-shadow: 0 2px 15px rgba(0, 255, 0, 0.4); z-index: 2000; min-width: 300px;">
                <span class="stats-close-btn" onclick="closeShareModal()" style="position: absolute; top: 8px; right: 10px; font-size: 14px;">‚úï</span>
                <h2 style="color: var(--color-primary); text-align: center; margin-bottom: 12px; text-shadow: 0 0 5px var(--color-primary); font-size: 13px;">üîó SHARE</h2>
                <p style="color: var(--color-secondary); text-align: center; margin-bottom: 12px; font-size: 10px;">
                    Share this map with others
                </p>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button onclick="shareTwitter()" style="background: #1DA1F2; border: 1px solid #1DA1F2; border-radius: 2px; color: white; padding: 10px; font-family: 'Courier New', monospace; cursor: pointer; font-size: 11px; transition: all 0.2s;">
                        üê¶ Share on Twitter
                    </button>
                    <button onclick="shareLinkedIn()" style="background: #0077B5; border: 1px solid #0077B5; border-radius: 2px; color: white; padding: 10px; font-family: 'Courier New', monospace; cursor: pointer; font-size: 11px; transition: all 0.2s;">
                        üíº Share on LinkedIn
                    </button>
                    <button onclick="shareReddit()" style="background: #FF4500; border: 1px solid #FF4500; border-radius: 2px; color: white; padding: 10px; font-family: 'Courier New', monospace; cursor: pointer; font-size: 11px; transition: all 0.2s;">
                        üî¥ Share on Reddit
                    </button>
                    <button onclick="copyLink()" style="background: var(--bg-secondary); border: 1px solid var(--color-accent); border-radius: 2px; color: var(--color-primary); padding: 10px; font-family: 'Courier New', monospace; cursor: pointer; font-size: 11px; transition: all 0.2s;">
                        üìã Copy Link
                    </button>
                </div>
            </div>

            <div id="radius-panel" style="display: none; position: absolute; bottom: 60px; left: 10px; background: rgba(10, 10, 10, 0.98); border: 1px solid var(--color-accent); border-radius: 2px; padding: 12px; box-shadow: 0 2px 15px rgba(0, 255, 0, 0.4); z-index: 1000; min-width: 250px;">
                <span class="stats-close-btn" onclick="cancelRadiusSearch()" style="position: absolute; top: 8px; right: 10px; font-size: 12px;">‚úï</span>
                <h3 style="color: var(--color-primary); margin-bottom: 10px; text-shadow: 0 0 5px var(--color-primary); font-size: 11px;">üìç RADIUS</h3>
                <p style="color: var(--color-secondary); font-size: 9px; margin-bottom: 10px;">Click map to set center</p>
                <div style="margin-bottom: 10px;">
                    <label style="color: var(--color-primary); font-size: 10px; display: block; margin-bottom: 4px;">Radius:</label>
                    <input type="number" id="radius-input" value="50" min="1" max="10000" style="background: var(--bg-secondary); border: 1px solid var(--color-accent); border-radius: 2px; color: var(--color-primary); padding: 6px; width: 80px; font-family: 'Courier New', monospace; font-size: 10px;">
                    <select id="radius-unit" style="background: var(--bg-secondary); border: 1px solid var(--color-accent); border-radius: 2px; color: var(--color-primary); padding: 6px; font-family: 'Courier New', monospace; font-size: 10px;">
                        <option value="miles">Miles</option>
                        <option value="km">Km</option>
                    </select>
                </div>
                <div id="radius-results" style="color: var(--color-secondary); font-size: 9px; margin-top: 8px;"></div>
            </div>

            <div id="distance-panel" style="display: none; position: absolute; bottom: 60px; right: 10px; background: rgba(10, 10, 10, 0.98); border: 1px solid var(--color-accent); border-radius: 2px; padding: 12px; box-shadow: 0 2px 15px rgba(0, 255, 0, 0.4); z-index: 1000; min-width: 280px;">
                <span class="stats-close-btn" onclick="cancelDistanceCalc()" style="position: absolute; top: 8px; right: 10px; font-size: 12px;">‚úï</span>
                <h3 style="color: var(--color-primary); margin-bottom: 10px; text-shadow: 0 0 5px var(--color-primary); font-size: 11px;">üìè DISTANCE</h3>
                <p id="distance-instruction" style="color: var(--color-secondary); font-size: 9px; margin-bottom: 10px;">Click map to set Point A</p>
                <div style="margin-bottom: 10px;">
                    <label style="color: var(--color-primary); font-size: 10px; display: block; margin-bottom: 4px;">Units:</label>
                    <select id="distance-unit" style="background: var(--bg-secondary); border: 1px solid var(--color-accent); border-radius: 2px; color: var(--color-primary); padding: 6px; font-family: 'Courier New', monospace; font-size: 10px; width: 100%;">
                        <option value="miles">Miles</option>
                        <option value="km">Km</option>
                        <option value="nm">Nautical</option>
                    </select>
                </div>
                <div id="distance-points" style="color: var(--color-secondary); font-size: 9px; margin-bottom: 10px;">
                    <div style="margin-bottom: 5px;">
                        <strong style="color: var(--color-primary);">A:</strong> <span id="point-a">Not set</span>
                    </div>
                    <div>
                        <strong style="color: var(--color-primary);">B:</strong> <span id="point-b">Not set</span>
                    </div>
                </div>
                <div id="distance-result" style="color: var(--color-primary); font-size: 12px; font-weight: bold; text-align: center; padding: 10px; border: 1px solid var(--color-accent); border-radius: 2px; background: rgba(0, 255, 0, 0.08); display: none; text-shadow: 0 0 5px var(--color-primary);">
                </div>
                <button id="clear-distance" onclick="clearDistanceMeasurement()" style="display: none; width: 100%; margin-top: 10px; background: var(--bg-secondary); border: 1px solid var(--color-accent); border-radius: 2px; color: var(--color-primary); padding: 8px; font-family: 'Courier New', monospace; cursor: pointer; font-size: 10px;">
                    üîÑ Clear
                </button>
            </div>

            <div id="proximity-panel" style="display: none; position: absolute; top: 80px; right: 10px; background: rgba(10, 10, 10, 0.98); border: 1px solid var(--color-accent); border-radius: 2px; padding: 12px; box-shadow: 0 2px 15px rgba(0, 255, 0, 0.4); z-index: 1000; min-width: 280px; max-height: 60vh; overflow-y: auto;">
                <span class="stats-close-btn" onclick="cancelProximityAnalysis()" style="position: absolute; top: 8px; right: 10px; font-size: 12px;">‚úï</span>
                <h3 style="color: var(--color-primary); margin-bottom: 10px; text-shadow: 0 0 5px var(--color-primary); font-size: 11px;">üéØ PROXIMITY</h3>
                <p style="color: var(--color-secondary); font-size: 9px; margin-bottom: 10px;">Click facility to find neighbors</p>
                <div style="margin-bottom: 10px;">
                    <label style="color: var(--color-primary); font-size: 10px; display: block; margin-bottom: 4px;">Neighbors:</label>
                    <input type="number" id="proximity-count" value="10" min="1" max="50" style="background: var(--bg-secondary); border: 1px solid var(--color-accent); border-radius: 2px; color: var(--color-primary); padding: 6px; width: 100%; font-family: 'Courier New', monospace; font-size: 10px;">
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="color: var(--color-primary); font-size: 10px; display: block; margin-bottom: 4px;">Units:</label>
                    <select id="proximity-unit" style="background: var(--bg-secondary); border: 1px solid var(--color-accent); border-radius: 2px; color: var(--color-primary); padding: 6px; font-family: 'Courier New', monospace; font-size: 10px; width: 100%;">
                        <option value="miles">Miles</option>
                        <option value="km">Km</option>
                    </select>
                </div>
                <div id="proximity-target" style="color: var(--color-primary); font-size: 10px; margin-bottom: 10px; padding: 8px; border: 1px solid var(--color-accent); border-radius: 2px; background: rgba(0, 255, 0, 0.08); display: none;">
                    <strong>Target:</strong><br>
                    <span id="proximity-target-name"></span><br>
                    <small id="proximity-target-location" style="font-size: 9px;"></small>
                </div>
                <div id="proximity-results" style="color: var(--color-secondary); font-size: 9px;"></div>
            </div>

            <div class="legend">
                <div style="color: var(--color-primary); font-weight: bold; margin-bottom: 6px; font-size: 9px;">MARKERS</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00ff00; box-shadow: 0 0 5px #00ff00;"></div>
                    <span style="font-size: 8px;">1-20</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffff00; box-shadow: 0 0 5px #ffff00;"></div>
                    <span style="font-size: 8px;">21-50</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff8800; box-shadow: 0 0 5px #ff8800;"></div>
                    <span style="font-size: 8px;">51-100</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff0000; box-shadow: 0 0 5px #ff0000;"></div>
                    <span style="font-size: 8px;">100+</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script>
        console.log('Script starting...');

        let datacenters = [];
        let map;
        let markerClusterGroup;
        let heatLayer;
        let allMarkers = [];
        let showHeatmap = false;

        // Chart variables
        let countriesChart = null;
        let companiesChart = null;
        let qualityChart = null;
        let regionalChart = null;

        // Theme and tile layer variables
        let currentTileLayer = null;

        // Radius search variables
        let radiusSearchActive = false;
        let radiusCircle = null;
        let radiusMarker = null;

        // Distance calculator variables
        let distanceCalcActive = false;
        let distancePointA = null;
        let distancePointB = null;
        let distanceMarkerA = null;
        let distanceMarkerB = null;
        let distanceLine = null;

        // Proximity analysis variables
        let proximityActive = false;
        let proximityLines = [];
        const tileLayers = {
            matrix: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap ¬© CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            }),
            light: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Esri, DigitalGlobe, GeoEye, Earthstar Geographics'
            }),
            topographic: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenTopoMap'
            }),
            ocean: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Esri, GEBCO, NOAA'
            })
        };

        // US State coordinates
        const usStateCoords = {
            'Alabama': [32.806671, -86.791130],
            'Alaska': [61.370716, -152.404419],
            'Arizona': [33.729759, -111.431221],
            'Arkansas': [34.969704, -92.373123],
            'California': [36.116203, -119.681564],
            'Colorado': [39.059811, -105.311104],
            'Connecticut': [41.597782, -72.755371],
            'Delaware': [39.318523, -75.507141],
            'Florida': [27.766279, -81.686783],
            'Georgia': [33.040619, -83.643074],
            'Hawaii': [21.3069, -157.8583],
            'Idaho': [44.240459, -114.478828],
            'Illinois': [40.349457, -88.986137],
            'Indiana': [39.849426, -86.258278],
            'Iowa': [42.011539, -93.210526],
            'Kansas': [38.526600, -96.726486],
            'Kentucky': [37.668140, -84.670067],
            'Louisiana': [31.169546, -91.867805],
            'Maine': [44.693947, -69.381927],
            'Maryland': [39.063946, -76.802101],
            'Massachusetts': [42.230171, -71.530106],
            'Michigan': [43.326618, -84.536095],
            'Minnesota': [45.694454, -93.900192],
            'Mississippi': [32.741646, -89.678696],
            'Missouri': [38.456085, -92.288368],
            'Montana': [46.921925, -110.454353],
            'Nebraska': [41.125370, -98.268082],
            'Nevada': [38.313515, -117.055374],
            'New Hampshire': [43.452492, -71.563896],
            'New Jersey': [40.298904, -74.521011],
            'New Mexico': [34.840515, -106.248482],
            'New York': [42.165726, -74.948051],
            'North Carolina': [35.630066, -79.806419],
            'North Dakota': [47.528912, -99.784012],
            'Ohio': [40.388783, -82.764915],
            'Oklahoma': [35.565342, -96.928917],
            'Oregon': [44.572021, -122.070938],
            'Pennsylvania': [40.590752, -77.209755],
            'Rhode Island': [41.680893, -71.511780],
            'South Carolina': [33.856892, -80.945007],
            'South Dakota': [44.299782, -99.438828],
            'Tennessee': [35.747845, -86.692345],
            'Texas': [31.054487, -97.563461],
            'Utah': [40.150032, -111.862434],
            'Vermont': [44.045876, -72.710686],
            'Virginia': [37.769337, -78.169968],
            'Washington': [47.400902, -121.490494],
            'West Virginia': [38.491226, -80.954453],
            'Wisconsin': [44.268543, -89.616508],
            'Wyoming': [42.755966, -107.302490],
            'District of Columbia': [38.907192, -77.036871]
        };

        // Comprehensive country coordinates
        const countryCoords = {
            'United States': [37.0902, -95.7129],
            'United Kingdom': [55.3781, -3.4360],
            'Netherlands': [52.1326, 5.2913],
            'France': [46.2276, 2.2137],
            'Germany': [51.1657, 10.4515],
            'Australia': [-25.2744, 133.7751],
            'Canada': [56.1304, -106.3468],
            'India': [20.5937, 78.9629],
            'Brazil': [-14.2350, -51.9253],
            'China': [35.8617, 104.1954],
            'Switzerland': [46.8182, 8.2275],
            'Spain': [40.4637, -3.7492],
            'Italy': [41.8719, 12.5674],
            'Japan': [36.2048, 138.2529],
            'Sweden': [60.1282, 18.6435],
            'Singapore': [1.3521, 103.8198],
            'Russia': [61.5240, 105.3188],
            'South Africa': [-30.5595, 22.9375],
            'Ireland': [53.1424, -7.6921],
            'Mexico': [23.6345, -102.5528],
            'Belgium': [50.5039, 4.4699],
            'Poland': [51.9194, 19.1451],
            'Norway': [60.4720, 8.4689],
            'Denmark': [56.2639, 9.5018],
            'Finland': [61.9241, 25.7482],
            'Austria': [47.5162, 14.5501],
            'Portugal': [39.3999, -8.2245],
            'Czech Republic': [49.8175, 15.4730],
            'Greece': [39.0742, 21.8243],
            'Romania': [45.9432, 24.9668],
            'Hungary': [47.1625, 19.5033],
            'Turkey': [38.9637, 35.2433],
            'South Korea': [35.9078, 127.7669],
            'Thailand': [15.8700, 100.9925],
            'Malaysia': [4.2105, 101.9758],
            'Indonesia': [-0.7893, 113.9213],
            'Philippines': [12.8797, 121.7740],
            'Vietnam': [14.0583, 108.2772],
            'Hong Kong': [22.3193, 114.1694],
            'Taiwan': [23.6978, 120.9605],
            'New Zealand': [-40.9006, 174.8860],
            'Israel': [31.0461, 34.8516],
            'United Arab Emirates': [23.4241, 53.8478],
            'Saudi Arabia': [23.8859, 45.0792],
            'Egypt': [26.8206, 30.8025],
            'Nigeria': [9.0820, 8.6753],
            'Kenya': [-0.0236, 37.9062],
            'Ghana': [7.9465, -1.0232],
            'Argentina': [-38.4161, -63.6167],
            'Colombia': [4.5709, -74.2973],
            'Chile': [-35.6751, -71.5430],
            'Peru': [-9.1900, -75.0152],
            'Ukraine': [48.3794, 31.1656],
            'Pakistan': [30.3753, 69.3451],
            'Bangladesh': [23.6850, 90.3563],
            'Sri Lanka': [7.8731, 80.7718],
            'Bulgaria': [42.7339, 25.4858],
            'Serbia': [44.0165, 21.0059],
            'Croatia': [45.1000, 15.2000],
            'Slovenia': [46.1512, 14.9955],
            'Slovakia': [48.6690, 19.6990],
            'Lithuania': [55.1694, 23.8813],
            'Latvia': [56.8796, 24.6032],
            'Estonia': [58.5953, 25.0136],
            'Iceland': [64.1466, -21.9426],
            'Luxembourg': [49.8153, 6.1296],
            'Malta': [35.9375, 14.3754],
            'Cyprus': [35.1264, 33.4299],
            'Qatar': [25.3548, 51.1839],
            'Kuwait': [29.3117, 47.4818],
            'Oman': [21.4735, 55.9754],
            'Jordan': [30.5852, 36.2384],
            'Lebanon': [33.8547, 35.8623],
            'Morocco': [31.7917, -7.0926],
            'Tunisia': [33.8869, 9.5375],
            'Algeria': [28.0339, 1.6596],
            'Iran': [32.4279, 53.6880],
            'Kazakhstan': [48.0196, 66.9237],
            'Belarus': [53.7098, 27.9534],
            'Azerbaijan': [40.1431, 47.5769],
            'Armenia': [40.0691, 45.0382],
            'Moldova': [47.4116, 28.3699],
            'Unknown': [0, 0]
        };

        // Initialize map
        function initMap() {
            console.log('Initializing map...');
            map = L.map('globe', {
                center: [20, 0],
                zoom: 2,
                minZoom: 2,
                maxZoom: 18
            });

            // Load saved theme or default to matrix
            const savedTheme = localStorage.getItem('atlas-theme') || 'matrix';
            currentTileLayer = tileLayers[savedTheme];
            currentTileLayer.addTo(map);
            document.body.className = savedTheme !== 'matrix' ? `theme-${savedTheme}` : '';
            document.getElementById('theme-selector').value = savedTheme;

            // Initialize marker cluster group with custom styling
            markerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 50,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                iconCreateFunction: function(cluster) {
                    var childCount = cluster.getChildCount();
                    var c = ' marker-cluster-';
                    if (childCount < 10) {
                        c += 'small';
                    } else if (childCount < 100) {
                        c += 'medium';
                    } else {
                        c += 'large';
                    }
                    return new L.DivIcon({
                        html: '<div><span>' + childCount + '</span></div>',
                        className: 'marker-cluster' + c,
                        iconSize: new L.Point(40, 40)
                    });
                }
            });
            map.addLayer(markerClusterGroup);

            // Map click handler for radius search and distance calculator
            map.on('click', function(e) {
                if (radiusSearchActive) {
                    performRadiusSearch(e.latlng.lat, e.latlng.lng);
                } else if (distanceCalcActive) {
                    performDistanceCalculation(e.latlng.lat, e.latlng.lng);
                }
            });

            console.log('Map initialized with clustering');
        }

        // Generate random offset for clustering
        function getRandomOffset() {
            return (Math.random() - 0.5) * 0.3; // Small spread to avoid exact overlap
        }

        // API configuration
        const API_BASE = 'https://atlas-api.squirequirk.workers.dev';

        // Load data
        async function loadData() {
            console.log('Loading data from R2 via Worker API...');
            try {
                const response = await fetch(`${API_BASE}/api/all`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const apiData = await response.json();
                datacenters = apiData.results || apiData;
                console.log(`Loaded ${datacenters.length} datacenters from R2`);

                document.getElementById('total-count').textContent = datacenters.length;

                populateFilters();
                addMarkers(datacenters);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('visible-count').textContent = datacenters.length;

                const uniqueCountries = new Set(datacenters.map(dc => dc.country));
                document.getElementById('country-count').textContent = uniqueCountries.size;

                console.log('Data loaded successfully');
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').textContent = 'ERROR: ' + error.message;
                document.getElementById('loading').style.color = '#ff0000';
            }
        }

        function addMarkers(data) {
            console.log(`Adding ${data.length} markers...`);
            markerClusterGroup.clearLayers();
            allMarkers = [];

            // Count datacenters per country
            const countryCount = {};
            data.forEach(dc => {
                countryCount[dc.country] = (countryCount[dc.country] || 0) + 1;
            });

            let markersAdded = 0;
            data.forEach((dc, index) => {
                let lat, lng;
                let useOffset = true;

                // Priority 1: Exact coordinates (no offset needed)
                if (dc.lat && dc.lon) {
                    lat = dc.lat;
                    lng = dc.lon;
                    useOffset = false;
                }
                // Priority 2: City coordinates (small offset)
                else if (dc.city_coords && Array.isArray(dc.city_coords) && dc.city_coords.length === 2) {
                    lat = dc.city_coords[0];
                    lng = dc.city_coords[1];
                }
                // Priority 3: State coordinates for US (medium offset)
                else if (dc.country === 'United States' && dc.state && usStateCoords[dc.state]) {
                    let coords = usStateCoords[dc.state];
                    lat = coords[0];
                    lng = coords[1];
                }
                // Priority 4: Country coordinates (larger offset)
                else {
                    let coords = countryCoords[dc.country];
                    if (!coords) {
                        console.warn(`No coordinates for: ${dc.country}`);
                        coords = [0, 0];
                    }
                    lat = coords[0];
                    lng = coords[1];
                }

                // Add small random offset to avoid exact overlaps
                if (useOffset) {
                    lat += getRandomOffset();
                    lng += getRandomOffset();
                }

                // Color based on country density
                let color = '#00ff00';
                const count = countryCount[dc.country];
                if (count > 100) {
                    color = '#ff0000';
                } else if (count > 50) {
                    color = '#ff8800';
                } else if (count > 20) {
                    color = '#ffff00';
                }

                const marker = L.circleMarker([lat, lng], {
                    radius: 5,
                    fillColor: color,
                    color: color,
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0.6
                });

                marker.bindPopup(`
                    <div style="color: #000; font-family: 'Courier New', monospace;">
                        <strong>${dc.name}</strong><br>
                        <em>${dc.company}</em><br>
                        ${dc.street || ''}<br>
                        ${dc.city || ''}${dc.state ? ', ' + dc.state : ''}${dc.zip ? ' ' + dc.zip : ''}<br>
                        <strong>${dc.country || ''}</strong>
                    </div>
                `);

                marker.on('click', () => {
                    if (proximityActive) {
                        performProximityAnalysis(dc);
                    } else {
                        showInfo(dc);
                    }
                });
                markerClusterGroup.addLayer(marker);
                allMarkers.push({ marker, data: dc });
                markersAdded++;
            });

            console.log(`Added ${markersAdded} markers to map`);
        }

        function populateFilters() {
            console.log('Populating filters...');
            const countries = [...new Set(datacenters.map(dc => dc.country))].sort();
            const companies = [...new Set(datacenters.map(dc => dc.company))].sort();

            const countryFilter = document.getElementById('country-filter');
            const companyFilter = document.getElementById('company-filter');

            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryFilter.appendChild(option);
            });

            companies.slice(0, 200).forEach(company => {
                if (company) {
                    const option = document.createElement('option');
                    option.value = company;
                    option.textContent = company;
                    companyFilter.appendChild(option);
                }
            });
            console.log('Filters populated');
        }

        // State abbreviations map
        const stateAbbreviations = {
            'alabama': 'AL', 'alaska': 'AK', 'arizona': 'AZ', 'arkansas': 'AR',
            'california': 'CA', 'colorado': 'CO', 'connecticut': 'CT', 'delaware': 'DE',
            'florida': 'FL', 'georgia': 'GA', 'hawaii': 'HI', 'idaho': 'ID',
            'illinois': 'IL', 'indiana': 'IN', 'iowa': 'IA', 'kansas': 'KS',
            'kentucky': 'KY', 'louisiana': 'LA', 'maine': 'ME', 'maryland': 'MD',
            'massachusetts': 'MA', 'michigan': 'MI', 'minnesota': 'MN', 'mississippi': 'MS',
            'missouri': 'MO', 'montana': 'MT', 'nebraska': 'NE', 'nevada': 'NV',
            'new hampshire': 'NH', 'new jersey': 'NJ', 'new mexico': 'NM', 'new york': 'NY',
            'north carolina': 'NC', 'north dakota': 'ND', 'ohio': 'OH', 'oklahoma': 'OK',
            'oregon': 'OR', 'pennsylvania': 'PA', 'rhode island': 'RI', 'south carolina': 'SC',
            'south dakota': 'SD', 'tennessee': 'TN', 'texas': 'TX', 'utah': 'UT',
            'vermont': 'VT', 'virginia': 'VA', 'washington': 'WA', 'west virginia': 'WV',
            'wisconsin': 'WI', 'wyoming': 'WY'
        };

        function filterData() {
            console.log('Filtering data...');
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const countryFilter = document.getElementById('country-filter').value;
            const companyFilter = document.getElementById('company-filter').value;

            // Check if search term is a state name and get abbreviation
            const stateAbbr = stateAbbreviations[searchTerm];

            const filtered = datacenters.filter(dc => {
                // If searching for a US state, match addresses with that state abbr
                if (stateAbbr) {
                    return (dc.state && dc.state.toLowerCase().includes(searchTerm)) ||
                           dc.address.includes(' ' + stateAbbr + ' ') ||
                           dc.address.toLowerCase().includes(searchTerm);
                }

                const matchesSearch = !searchTerm ||
                    dc.name.toLowerCase().includes(searchTerm) ||
                    dc.company.toLowerCase().includes(searchTerm) ||
                    (dc.country && dc.country.toLowerCase().includes(searchTerm)) ||
                    (dc.state && dc.state.toLowerCase().includes(searchTerm)) ||
                    (dc.city && dc.city.toLowerCase().includes(searchTerm)) ||
                    (dc.street && dc.street.toLowerCase().includes(searchTerm)) ||
                    dc.address.toLowerCase().includes(searchTerm);

                const matchesCountry = !countryFilter || dc.country === countryFilter;
                const matchesCompany = !companyFilter || dc.company === companyFilter;

                return matchesSearch && matchesCountry && matchesCompany;
            });

            console.log(`Filtered to ${filtered.length} datacenters`);
            addMarkers(filtered);
            document.getElementById('visible-count').textContent = filtered.length;

            // Show results panel if searching and has results
            if (searchTerm && filtered.length > 0) {
                showResults(filtered);
            } else {
                closeResults();
            }
        }

        function showResults(results) {
            const resultsList = document.getElementById('results-list');
            resultsList.innerHTML = '';

            // Show message if too many results
            if (results.length > 200) {
                resultsList.innerHTML = `
                    <div style="color: #ffaa00; padding: 10px; border: 1px solid #ffaa00; margin-bottom: 10px;">
                        Showing first 200 of ${results.length} results. Refine search for better results.
                    </div>
                `;
            }

            // Limit display to first 200 results
            const displayResults = results.slice(0, 200);

            displayResults.forEach(dc => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerHTML = `
                    <div class="result-name">${dc.name}</div>
                    <div class="result-details">
                        ${dc.company}<br>
                        ${dc.city || ''}${dc.state ? ', ' + dc.state : ''} ${dc.country || ''}
                    </div>
                `;
                item.onclick = () => {
                    showInfo(dc);
                    // Find and highlight marker
                    const marker = allMarkers.find(m => m.data === dc);
                    if (marker) {
                        map.setView([marker.marker.getLatLng().lat, marker.marker.getLatLng().lng], 10);
                        marker.marker.openPopup();
                    }
                };
                resultsList.appendChild(item);
            });

            document.getElementById('results-panel').style.display = 'block';
        }

        function closeResults() {
            document.getElementById('results-panel').style.display = 'none';
        }

        function showInfo(dc) {
            document.getElementById('info-panel').style.display = 'block';
            document.getElementById('info-title').textContent = dc.name;
            document.getElementById('info-company').textContent = dc.company;
            document.getElementById('info-street').textContent = dc.street || 'N/A';
            document.getElementById('info-city').textContent = dc.city || 'N/A';
            document.getElementById('info-state').textContent = dc.state || 'N/A';
            document.getElementById('info-country').textContent = dc.country || 'N/A';
        }

        function closeInfo() {
            document.getElementById('info-panel').style.display = 'none';
        }

        function closeStatsDashboard() {
            document.getElementById('stats-dashboard').style.display = 'none';
            document.getElementById('stats-toggle').style.background = '#1a1a1a';
            document.getElementById('stats-toggle').style.color = '#00ff00';
        }

        function toggleStatsDashboard() {
            const dashboard = document.getElementById('stats-dashboard');
            const toggleBtn = document.getElementById('stats-toggle');

            if (dashboard.style.display === 'none' || dashboard.style.display === '') {
                dashboard.style.display = 'block';
                toggleBtn.style.background = '#00ff00';
                toggleBtn.style.color = '#000';
                updateStatsDashboard();
            } else {
                closeStatsDashboard();
            }
        }

        // Heatmap Toggle Function
        function toggleHeatmap() {
            showHeatmap = !showHeatmap;

            if (showHeatmap) {
                // Generate heatmap data from current visible markers
                const heatData = [];
                datacenters.forEach(dc => {
                    let lat, lng;
                    if (dc.city_coords && Array.isArray(dc.city_coords) && dc.city_coords.length === 2) {
                        lat = dc.city_coords[0];
                        lng = dc.city_coords[1];
                    } else if (dc.country === 'United States' && dc.state && usStateCoords[dc.state]) {
                        let coords = usStateCoords[dc.state];
                        lat = coords[0];
                        lng = coords[1];
                    } else {
                        let coords = countryCoords[dc.country];
                        if (coords) {
                            lat = coords[0];
                            lng = coords[1];
                        }
                    }

                    if (lat && lng && lat !== 0 && lng !== 0) {
                        heatData.push([lat, lng, 0.5]); // lat, lng, intensity
                    }
                });

                // Create heatmap layer
                heatLayer = L.heatLayer(heatData, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 10,
                    max: 1.0,
                    gradient: {
                        0.0: '#000000',
                        0.2: '#00ff00',
                        0.4: '#ffff00',
                        0.6: '#ff8800',
                        0.8: '#ff0000',
                        1.0: '#ff00ff'
                    }
                }).addTo(map);

                // Hide markers
                map.removeLayer(markerClusterGroup);
                document.getElementById('heatmap-toggle').style.background = '#00ff00';
                document.getElementById('heatmap-toggle').style.color = '#000';
            } else {
                // Remove heatmap, show markers
                if (heatLayer) {
                    map.removeLayer(heatLayer);
                }
                map.addLayer(markerClusterGroup);
                document.getElementById('heatmap-toggle').style.background = '#1a1a1a';
                document.getElementById('heatmap-toggle').style.color = '#00ff00';
            }
        }

        // Update Statistics Dashboard
        function updateStatsDashboard() {
            // Get current filtered data
            const visibleData = allMarkers
                .filter(marker => marker.marker._icon && marker.marker._icon.style.display !== 'none')
                .map(m => m.data);

            // Update key metrics
            const uniqueCountries = new Set(datacenters.filter(dc => dc.country).map(dc => dc.country));
            const uniqueCompanies = new Set(datacenters.filter(dc => dc.company).map(dc => dc.company));

            document.getElementById('metric-total').textContent = datacenters.length.toLocaleString();
            document.getElementById('metric-countries').textContent = uniqueCountries.size;
            document.getElementById('metric-companies').textContent = uniqueCompanies.size;
            document.getElementById('metric-visible').textContent = visibleData.length.toLocaleString();

            // Prepare data for charts
            const countryCount = {};
            const companyCount = {};

            datacenters.forEach(dc => {
                if (dc.country) {
                    countryCount[dc.country] = (countryCount[dc.country] || 0) + 1;
                }
                if (dc.company) {
                    companyCount[dc.company] = (companyCount[dc.company] || 0) + 1;
                }
            });

            // Get top 10 countries
            const topCountries = Object.entries(countryCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            // Get top 10 companies
            const topCompanies = Object.entries(companyCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            // Matrix theme colors
            const chartColors = [
                '#00ff00', '#00dd00', '#00bb00', '#009900', '#007700',
                '#ffff00', '#dddd00', '#ff8800', '#ff6600', '#ff4400'
            ];

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#00ff00', font: { family: 'Courier New', size: 10 } },
                        grid: { color: 'rgba(0, 255, 0, 0.1)' }
                    },
                    y: {
                        ticks: { color: '#00ff00', font: { family: 'Courier New', size: 10 } },
                        grid: { color: 'rgba(0, 255, 0, 0.1)' }
                    }
                }
            };

            // Countries Chart
            if (countriesChart) countriesChart.destroy();
            countriesChart = new Chart(document.getElementById('countriesChart'), {
                type: 'bar',
                data: {
                    labels: topCountries.map(c => c[0]),
                    datasets: [{
                        label: 'Facilities',
                        data: topCountries.map(c => c[1]),
                        backgroundColor: chartColors,
                        borderColor: '#00ff00',
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            });

            // Companies Chart
            if (companiesChart) companiesChart.destroy();
            companiesChart = new Chart(document.getElementById('companiesChart'), {
                type: 'bar',
                data: {
                    labels: topCompanies.map(c => c[0].length > 15 ? c[0].substring(0, 15) + '...' : c[0]),
                    datasets: [{
                        label: 'Facilities',
                        data: topCompanies.map(c => c[1]),
                        backgroundColor: chartColors,
                        borderColor: '#00ff00',
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            });

            // Data Quality Chart
            const withCoords = datacenters.filter(dc => dc.city_coords && dc.city_coords[0] !== 0).length;
            const withCountry = datacenters.filter(dc => dc.country).length;
            const withState = datacenters.filter(dc => dc.state).length;
            const withoutCountry = datacenters.length - withCountry;

            if (qualityChart) qualityChart.destroy();
            qualityChart = new Chart(document.getElementById('qualityChart'), {
                type: 'doughnut',
                data: {
                    labels: ['City Coords', 'Has Country', 'Has State', 'Missing Country'],
                    datasets: [{
                        data: [withCoords, withCountry, withState, withoutCountry],
                        backgroundColor: ['#00ff00', '#00dd00', '#ffff00', '#ff0000'],
                        borderColor: '#000',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#00ff00',
                                font: { family: 'Courier New', size: 10 }
                            }
                        }
                    }
                }
            });

            // Regional Distribution
            const regions = {
                'North America': 0,
                'Europe': 0,
                'Asia-Pacific': 0,
                'South America': 0,
                'Africa': 0,
                'Middle East': 0,
                'Other': 0
            };

            const regionMap = {
                'United States': 'North America', 'Canada': 'North America', 'Mexico': 'North America',
                'United Kingdom': 'Europe', 'France': 'Europe', 'Germany': 'Europe', 'Netherlands': 'Europe',
                'Spain': 'Europe', 'Italy': 'Europe', 'Switzerland': 'Europe', 'Sweden': 'Europe',
                'Ireland': 'Europe', 'Poland': 'Europe', 'Belgium': 'Europe', 'Austria': 'Europe',
                'Norway': 'Europe', 'Denmark': 'Europe', 'Finland': 'Europe', 'Portugal': 'Europe',
                'China': 'Asia-Pacific', 'Japan': 'Asia-Pacific', 'India': 'Asia-Pacific', 'Singapore': 'Asia-Pacific',
                'Australia': 'Asia-Pacific', 'South Korea': 'Asia-Pacific', 'Indonesia': 'Asia-Pacific',
                'Malaysia': 'Asia-Pacific', 'Thailand': 'Asia-Pacific', 'New Zealand': 'Asia-Pacific',
                'Brazil': 'South America', 'Argentina': 'South America', 'Chile': 'South America',
                'Colombia': 'South America', 'Peru': 'South America',
                'South Africa': 'Africa', 'Nigeria': 'Africa', 'Kenya': 'Africa', 'Egypt': 'Africa',
                'Saudi Arabia': 'Middle East', 'United Arab Emirates': 'Middle East', 'Israel': 'Middle East',
                'Qatar': 'Middle East', 'Kuwait': 'Middle East'
            };

            datacenters.forEach(dc => {
                const region = regionMap[dc.country] || 'Other';
                regions[region]++;
            });

            if (regionalChart) regionalChart.destroy();
            regionalChart = new Chart(document.getElementById('regionalChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(regions),
                    datasets: [{
                        data: Object.values(regions),
                        backgroundColor: chartColors.slice(0, 7),
                        borderColor: '#000',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#00ff00',
                                font: { family: 'Courier New', size: 10 }
                            }
                        }
                    }
                }
            });
        }

        // Haversine Distance Calculation (returns distance in kilometers)
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Radius Search Functions
        function activateRadiusSearch() {
            radiusSearchActive = true;
            document.getElementById('radius-panel').style.display = 'block';
            document.getElementById('radius-search-btn').style.background = '#00ff00';
            document.getElementById('radius-search-btn').style.color = '#000';
            map.getContainer().style.cursor = 'crosshair';
        }

        function cancelRadiusSearch() {
            radiusSearchActive = false;
            document.getElementById('radius-panel').style.display = 'none';
            document.getElementById('radius-search-btn').style.background = '#1a1a1a';
            document.getElementById('radius-search-btn').style.color = '#00ff00';
            document.getElementById('radius-results').innerHTML = '';
            map.getContainer().style.cursor = '';

            if (radiusCircle) {
                map.removeLayer(radiusCircle);
                radiusCircle = null;
            }
            if (radiusMarker) {
                map.removeLayer(radiusMarker);
                radiusMarker = null;
            }
        }

        function performRadiusSearch(lat, lon) {
            const radiusValue = parseFloat(document.getElementById('radius-input').value);
            const unit = document.getElementById('radius-unit').value;
            const radiusKm = unit === 'miles' ? radiusValue * 1.60934 : radiusValue;

            // Remove existing circle and marker
            if (radiusCircle) map.removeLayer(radiusCircle);
            if (radiusMarker) map.removeLayer(radiusMarker);

            // Draw circle
            radiusCircle = L.circle([lat, lon], {
                radius: radiusKm * 1000, // Convert to meters
                color: '#00ff00',
                fillColor: '#00ff00',
                fillOpacity: 0.1,
                weight: 2
            }).addTo(map);

            // Add center marker
            radiusMarker = L.marker([lat, lon], {
                icon: L.divIcon({
                    className: 'radius-center-marker',
                    html: '<div style="background: #00ff00; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #000; box-shadow: 0 0 10px #00ff00;"></div>',
                    iconSize: [12, 12]
                })
            }).addTo(map);

            // Find facilities within radius
            const facilitiesInRadius = [];
            datacenters.forEach(dc => {
                let dcLat, dcLon;
                if (dc.city_coords && dc.city_coords[0] !== 0) {
                    dcLat = dc.city_coords[0];
                    dcLon = dc.city_coords[1];
                } else if (dc.country === 'United States' && dc.state && usStateCoords[dc.state]) {
                    dcLat = usStateCoords[dc.state][0];
                    dcLon = usStateCoords[dc.state][1];
                } else if (dc.country && countryCoords[dc.country]) {
                    dcLat = countryCoords[dc.country][0];
                    dcLon = countryCoords[dc.country][1];
                }

                if (dcLat && dcLon) {
                    const distance = haversineDistance(lat, lon, dcLat, dcLon);
                    if (distance <= radiusKm) {
                        facilitiesInRadius.push({
                            ...dc,
                            distance: unit === 'miles' ? distance / 1.60934 : distance
                        });
                    }
                }
            });

            // Sort by distance
            facilitiesInRadius.sort((a, b) => a.distance - b.distance);

            // Display results
            const resultsDiv = document.getElementById('radius-results');
            const unitLabel = unit === 'miles' ? 'mi' : 'km';
            resultsDiv.innerHTML = `<strong style="color: #00ff00;">${facilitiesInRadius.length} facilities found</strong><br><br>`;

            if (facilitiesInRadius.length > 0) {
                resultsDiv.innerHTML += facilitiesInRadius.slice(0, 10).map(dc =>
                    `<div style="margin-bottom: 8px; padding: 5px; border: 1px solid #006600;">
                        <strong>${dc.name}</strong><br>
                        <small>${dc.city || 'N/A'}, ${dc.country || 'N/A'}</small><br>
                        <small style="color: #00ff00;">${dc.distance.toFixed(2)} ${unitLabel} away</small>
                    </div>`
                ).join('');

                if (facilitiesInRadius.length > 10) {
                    resultsDiv.innerHTML += `<small style="color: #00aa00;">...and ${facilitiesInRadius.length - 10} more</small>`;
                }
            }

            // Fit map to circle
            map.fitBounds(radiusCircle.getBounds(), { padding: [50, 50] });
        }

        // Distance Calculator Functions
        function activateDistanceCalc() {
            // Cancel radius search if active
            if (radiusSearchActive) {
                cancelRadiusSearch();
            }

            distanceCalcActive = true;
            document.getElementById('distance-panel').style.display = 'block';
            document.getElementById('distance-calc-btn').style.background = '#00ff00';
            document.getElementById('distance-calc-btn').style.color = '#000';
            map.getContainer().style.cursor = 'crosshair';

            // Reset state
            clearDistanceMeasurement();
        }

        function cancelDistanceCalc() {
            distanceCalcActive = false;
            document.getElementById('distance-panel').style.display = 'none';
            document.getElementById('distance-calc-btn').style.background = '#1a1a1a';
            document.getElementById('distance-calc-btn').style.color = '#00ff00';
            map.getContainer().style.cursor = '';

            clearDistanceMeasurement();
        }

        function clearDistanceMeasurement() {
            distancePointA = null;
            distancePointB = null;

            if (distanceMarkerA) {
                map.removeLayer(distanceMarkerA);
                distanceMarkerA = null;
            }
            if (distanceMarkerB) {
                map.removeLayer(distanceMarkerB);
                distanceMarkerB = null;
            }
            if (distanceLine) {
                map.removeLayer(distanceLine);
                distanceLine = null;
            }

            document.getElementById('point-a').textContent = 'Not set';
            document.getElementById('point-b').textContent = 'Not set';
            document.getElementById('distance-instruction').textContent = 'Click on the map to set Point A';
            document.getElementById('distance-result').style.display = 'none';
            document.getElementById('clear-distance').style.display = 'none';
        }

        function performDistanceCalculation(lat, lon) {
            if (!distancePointA) {
                // Set Point A
                distancePointA = { lat, lon };

                // Add marker A
                distanceMarkerA = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'distance-marker-a',
                        html: '<div style="background: #00ff00; width: 16px; height: 16px; border-radius: 50%; border: 3px solid #000; box-shadow: 0 0 10px #00ff00; position: relative;"><div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: #000; border: 1px solid #00ff00; padding: 2px 5px; white-space: nowrap; color: #00ff00; font-family: \'Courier New\'; font-size: 10px;">A</div></div>',
                        iconSize: [16, 16]
                    })
                }).addTo(map);

                document.getElementById('point-a').textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                document.getElementById('distance-instruction').textContent = 'Click on the map to set Point B';

            } else if (!distancePointB) {
                // Set Point B
                distancePointB = { lat, lon };

                // Add marker B
                distanceMarkerB = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'distance-marker-b',
                        html: '<div style="background: #ffff00; width: 16px; height: 16px; border-radius: 50%; border: 3px solid #000; box-shadow: 0 0 10px #ffff00; position: relative;"><div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: #000; border: 1px solid #ffff00; padding: 2px 5px; white-space: nowrap; color: #ffff00; font-family: \'Courier New\'; font-size: 10px;">B</div></div>',
                        iconSize: [16, 16]
                    })
                }).addTo(map);

                document.getElementById('point-b').textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;

                // Draw line
                distanceLine = L.polyline(
                    [[distancePointA.lat, distancePointA.lon], [distancePointB.lat, distancePointB.lon]],
                    {
                        color: '#00ff00',
                        weight: 3,
                        opacity: 0.8,
                        dashArray: '10, 10'
                    }
                ).addTo(map);

                // Calculate distance
                const distanceKm = haversineDistance(distancePointA.lat, distancePointA.lon, distancePointB.lat, distancePointB.lon);
                const unit = document.getElementById('distance-unit').value;
                let distance, unitLabel;

                if (unit === 'miles') {
                    distance = distanceKm / 1.60934;
                    unitLabel = 'miles';
                } else if (unit === 'nm') {
                    distance = distanceKm / 1.852;
                    unitLabel = 'nautical miles';
                } else {
                    distance = distanceKm;
                    unitLabel = 'kilometers';
                }

                // Display result
                document.getElementById('distance-result').innerHTML = `${distance.toFixed(2)} ${unitLabel}`;
                document.getElementById('distance-result').style.display = 'block';
                document.getElementById('clear-distance').style.display = 'block';
                document.getElementById('distance-instruction').textContent = 'Distance calculated!';

                // Fit map to show both points
                map.fitBounds(distanceLine.getBounds(), { padding: [50, 50] });
            }
        }

        // Proximity Analysis Functions
        function activateProximityAnalysis() {
            // Cancel other tools if active
            if (radiusSearchActive) cancelRadiusSearch();
            if (distanceCalcActive) cancelDistanceCalc();

            proximityActive = true;
            document.getElementById('proximity-panel').style.display = 'block';
            document.getElementById('proximity-btn').style.background = '#00ff00';
            document.getElementById('proximity-btn').style.color = '#000';
            document.getElementById('proximity-target').style.display = 'none';
            document.getElementById('proximity-results').innerHTML = '';

            // Clear any existing lines
            proximityLines.forEach(line => map.removeLayer(line));
            proximityLines = [];
        }

        function cancelProximityAnalysis() {
            proximityActive = false;
            document.getElementById('proximity-panel').style.display = 'none';
            document.getElementById('proximity-btn').style.background = '#1a1a1a';
            document.getElementById('proximity-btn').style.color = '#00ff00';

            // Clear proximity visualization
            proximityLines.forEach(line => map.removeLayer(line));
            proximityLines = [];
        }

        function performProximityAnalysis(targetFacility) {
            if (!proximityActive) return;

            const count = parseInt(document.getElementById('proximity-count').value);
            const unit = document.getElementById('proximity-unit').value;

            // Get target facility coordinates
            let targetLat, targetLon;
            if (targetFacility.city_coords && targetFacility.city_coords[0] !== 0) {
                targetLat = targetFacility.city_coords[0];
                targetLon = targetFacility.city_coords[1];
            } else if (targetFacility.country === 'United States' && targetFacility.state && usStateCoords[targetFacility.state]) {
                targetLat = usStateCoords[targetFacility.state][0];
                targetLon = usStateCoords[targetFacility.state][1];
            } else if (targetFacility.country && countryCoords[targetFacility.country]) {
                targetLat = countryCoords[targetFacility.country][0];
                targetLon = countryCoords[targetFacility.country][1];
            } else {
                alert('Cannot determine coordinates for this facility');
                return;
            }

            // Calculate distances to all other facilities
            const facilitiesWithDistance = [];
            datacenters.forEach(dc => {
                if (dc.name === targetFacility.name && dc.company === targetFacility.company) {
                    return; // Skip the target facility itself
                }

                let dcLat, dcLon;
                if (dc.city_coords && dc.city_coords[0] !== 0) {
                    dcLat = dc.city_coords[0];
                    dcLon = dc.city_coords[1];
                } else if (dc.country === 'United States' && dc.state && usStateCoords[dc.state]) {
                    dcLat = usStateCoords[dc.state][0];
                    dcLon = usStateCoords[dc.state][1];
                } else if (dc.country && countryCoords[dc.country]) {
                    dcLat = countryCoords[dc.country][0];
                    dcLon = countryCoords[dc.country][1];
                }

                if (dcLat && dcLon) {
                    const distanceKm = haversineDistance(targetLat, targetLon, dcLat, dcLon);
                    facilitiesWithDistance.push({
                        ...dc,
                        distance: unit === 'miles' ? distanceKm / 1.60934 : distanceKm,
                        lat: dcLat,
                        lon: dcLon
                    });
                }
            });

            // Sort by distance and take top N
            facilitiesWithDistance.sort((a, b) => a.distance - b.distance);
            const nearestNeighbors = facilitiesWithDistance.slice(0, count);

            // Display target facility
            document.getElementById('proximity-target').style.display = 'block';
            document.getElementById('proximity-target-name').textContent = targetFacility.name;
            document.getElementById('proximity-target-location').textContent =
                `${targetFacility.city || 'N/A'}, ${targetFacility.country || 'N/A'}`;

            // Clear previous lines
            proximityLines.forEach(line => map.removeLayer(line));
            proximityLines = [];

            // Draw lines to nearest neighbors
            const unitLabel = unit === 'miles' ? 'mi' : 'km';
            let resultsHtml = `<strong style="color: #00ff00;">${nearestNeighbors.length} Nearest Facilities:</strong><br><br>`;

            nearestNeighbors.forEach((neighbor, index) => {
                // Draw line
                const line = L.polyline(
                    [[targetLat, targetLon], [neighbor.lat, neighbor.lon]],
                    {
                        color: index < 3 ? '#00ff00' : '#ffff00',
                        weight: index < 3 ? 2 : 1,
                        opacity: 0.6,
                        dashArray: '5, 5'
                    }
                ).addTo(map);
                proximityLines.push(line);

                // Add to results
                resultsHtml += `
                    <div style="margin-bottom: 10px; padding: 8px; border: 1px solid ${index < 3 ? '#00ff00' : '#006600'}; background: ${index < 3 ? 'rgba(0, 255, 0, 0.1)' : 'transparent'};">
                        <strong style="color: ${index < 3 ? '#00ff00' : '#ffff00'};">#${index + 1}</strong> - ${neighbor.name}<br>
                        <small>${neighbor.company || 'N/A'}</small><br>
                        <small>${neighbor.city || 'N/A'}, ${neighbor.country || 'N/A'}</small><br>
                        <strong style="color: #00ff00;">${neighbor.distance.toFixed(2)} ${unitLabel}</strong>
                    </div>
                `;
            });

            document.getElementById('proximity-results').innerHTML = resultsHtml;

            // Zoom to show all facilities
            const bounds = L.latLngBounds([[targetLat, targetLon]]);
            nearestNeighbors.forEach(n => bounds.extend([n.lat, n.lon]));
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        // Export Modal Functions
        function openExportModal() {
            const visibleData = allMarkers
                .filter(marker => marker.marker._icon && marker.marker._icon.style.display !== 'none')
                .map(m => m.data);

            document.getElementById('export-count').textContent = visibleData.length.toLocaleString();
            document.getElementById('export-modal').style.display = 'block';
        }

        function closeExportModal() {
            document.getElementById('export-modal').style.display = 'none';
        }

        function getVisibleData() {
            return allMarkers
                .filter(marker => marker.marker._icon && marker.marker._icon.style.display !== 'none')
                .map(m => m.data);
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function exportCSV() {
            const data = getVisibleData();
            const headers = ['name', 'company', 'street', 'city', 'state', 'zip', 'country', 'address'];

            let csv = headers.join(',') + '\n';

            data.forEach(dc => {
                const row = headers.map(header => {
                    let value = dc[header] || '';
                    // Escape quotes and wrap in quotes if contains comma
                    if (value.toString().includes(',') || value.toString().includes('"')) {
                        value = '"' + value.toString().replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csv += row.join(',') + '\n';
            });

            const timestamp = new Date().toISOString().split('T')[0];
            downloadFile(csv, `atlas_export_${timestamp}.csv`, 'text/csv');
            closeExportModal();
        }

        function exportJSON() {
            const data = getVisibleData();
            const json = JSON.stringify(data, null, 2);
            const timestamp = new Date().toISOString().split('T')[0];
            downloadFile(json, `atlas_export_${timestamp}.json`, 'application/json');
            closeExportModal();
        }

        function exportGeoJSON() {
            const data = getVisibleData();

            const geojson = {
                type: 'FeatureCollection',
                features: data.map(dc => {
                    // Get coordinates
                    let coords = [0, 0];
                    if (dc.city_coords && dc.city_coords[0] !== 0) {
                        coords = [dc.city_coords[1], dc.city_coords[0]]; // GeoJSON is [lng, lat]
                    } else if (dc.country === 'United States' && dc.state && usStateCoords[dc.state]) {
                        coords = [usStateCoords[dc.state][1], usStateCoords[dc.state][0]];
                    } else if (dc.country && countryCoords[dc.country]) {
                        coords = [countryCoords[dc.country][1], countryCoords[dc.country][0]];
                    }

                    return {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: coords
                        },
                        properties: {
                            name: dc.name || '',
                            company: dc.company || '',
                            street: dc.street || '',
                            city: dc.city || '',
                            state: dc.state || '',
                            zip: dc.zip || '',
                            country: dc.country || '',
                            address: dc.address || ''
                        }
                    };
                })
            };

            const json = JSON.stringify(geojson, null, 2);
            const timestamp = new Date().toISOString().split('T')[0];
            downloadFile(json, `atlas_export_${timestamp}.geojson`, 'application/geo+json');
            closeExportModal();
        }

        // Export map screenshot with embedded metadata
        async function exportMapScreenshot() {
            closeExportModal();

            // Show loading message
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            loading.textContent = 'CAPTURING MAP SCREENSHOT...';

            // Wait for rendering
            await new Promise(resolve => setTimeout(resolve, 500));

            try {
                // Use leaflet-image or manual canvas approach
                // Get map container
                const mapContainer = document.getElementById('globe');

                // Create high-resolution canvas from map (2x scale for better quality)
                const scale = 2; // 2x resolution for crisp quality
                const canvas = await html2canvas(mapContainer, {
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#0a0a0a',
                    width: mapContainer.offsetWidth,
                    height: mapContainer.offsetHeight,
                    scale: scale, // High resolution capture
                    logging: false
                });

                // Get current view metadata
                const center = map.getCenter();
                const zoom = map.getZoom();
                const data = getVisibleData();
                const timestamp = new Date().toISOString();

                // Create metadata overlay on canvas (scaled for high-res)
                const ctx = canvas.getContext('2d');

                // Add watermark/metadata bar at bottom (scaled)
                const barHeight = 80 * scale;
                ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
                ctx.fillRect(0, canvas.height - barHeight, canvas.width, barHeight);

                // Add text (scaled for high-res)
                ctx.fillStyle = '#00ff00';
                ctx.font = `bold ${16 * scale}px "Courier New", monospace`;
                ctx.shadowColor = '#00ff00';
                ctx.shadowBlur = 10 * scale;
                ctx.fillText('üåç ATLAS Global Data Center Map - by ringmast4r', 20 * scale, canvas.height - barHeight + 25 * scale);

                ctx.font = `${12 * scale}px "Courier New", monospace`;
                ctx.fillStyle = '#00aa00';
                ctx.shadowBlur = 5 * scale;
                ctx.fillText(`üìä Facilities shown: ${data.length} | üìç Center: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)} | üîç Zoom: ${zoom}`, 20 * scale, canvas.height - barHeight + 45 * scale);
                ctx.fillText(`‚è∞ Captured: ${timestamp} | üåê ringmast4r.github.io/ATLAS_A-Data-Center-Project`, 20 * scale, canvas.height - barHeight + 65 * scale);

                // Convert to blob and download
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const fileTimestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
                    a.download = `atlas_map_ringmast4r_${fileTimestamp}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    loading.style.display = 'none';
                    loading.textContent = 'LOADING INTELLIGENCE DATA...';
                }, 'image/png', 1.0); // Maximum quality PNG

            } catch (error) {
                console.error('Screenshot export failed:', error);
                alert('Screenshot export requires html2canvas library. Using fallback method...');

                // Fallback: Just show instructions
                alert('To capture map:\n1. Press PrtScn on your keyboard\n2. Paste into image editor\n3. Save as PNG\n\nMap shows ' + getVisibleData().length + ' facilities');
                loading.style.display = 'none';
                loading.textContent = 'LOADING INTELLIGENCE DATA...';
            }
        }

        // Share Modal Functions
        function openShareModal() {
            document.getElementById('share-modal').style.display = 'block';
        }

        function closeShareModal() {
            document.getElementById('share-modal').style.display = 'none';
        }

        function shareTwitter() {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent('Check out this interactive map of 6,266+ data centers worldwide! üåç #DataCenter #CloudInfrastructure #OSINT');
            window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank');
            closeShareModal();
        }

        function shareLinkedIn() {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`, '_blank');
            closeShareModal();
        }

        function shareReddit() {
            const url = encodeURIComponent(window.location.href);
            const title = encodeURIComponent('Interactive Global Data Center Map - 6,266+ Locations Worldwide');
            window.open(`https://reddit.com/submit?url=${url}&title=${title}`, '_blank');
            closeShareModal();
        }

        async function copyLink() {
            try {
                await navigator.clipboard.writeText(window.location.href);
                // Change button text temporarily
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Copied!';
                btn.style.background = '#00ff00';
                btn.style.color = '#000';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = 'var(--bg-secondary)';
                    btn.style.color = 'var(--color-primary)';
                    closeShareModal();
                }, 1500);
            } catch (err) {
                alert('Link: ' + window.location.href);
                closeShareModal();
            }
        }

        // Change Theme Function
        function changeTheme(themeName) {
            // Remove current tile layer
            if (currentTileLayer) {
                map.removeLayer(currentTileLayer);
            }

            // Add new tile layer
            currentTileLayer = tileLayers[themeName];
            currentTileLayer.addTo(map);

            // Update body class for CSS theming
            if (themeName === 'matrix') {
                document.body.className = '';
            } else {
                document.body.className = `theme-${themeName}`;
            }

            // Save theme preference
            localStorage.setItem('atlas-theme', themeName);

            // Update chart colors if dashboard is open
            const dashboard = document.getElementById('stats-dashboard');
            if (dashboard && dashboard.style.display === 'block') {
                updateStatsDashboard();
            }

            console.log(`Theme changed to: ${themeName}`);
        }

        // Event listeners
        document.getElementById('search').addEventListener('input', filterData);
        document.getElementById('country-filter').addEventListener('change', filterData);
        document.getElementById('company-filter').addEventListener('change', filterData);
        document.getElementById('heatmap-toggle').addEventListener('click', toggleHeatmap);
        document.getElementById('stats-toggle').addEventListener('click', toggleStatsDashboard);
        document.getElementById('theme-selector').addEventListener('change', (e) => changeTheme(e.target.value));
        document.getElementById('export-btn').addEventListener('click', openExportModal);
        document.getElementById('share-btn').addEventListener('click', openShareModal);
        document.getElementById('radius-search-btn').addEventListener('click', activateRadiusSearch);
        document.getElementById('distance-calc-btn').addEventListener('click', activateDistanceCalc);
        document.getElementById('proximity-btn').addEventListener('click', activateProximityAnalysis);

        // Radius input change handler
        document.getElementById('radius-input').addEventListener('change', function() {
            if (radiusCircle && radiusMarker) {
                const center = radiusMarker.getLatLng();
                performRadiusSearch(center.lat, center.lng);
            }
        });
        document.getElementById('radius-unit').addEventListener('change', function() {
            if (radiusCircle && radiusMarker) {
                const center = radiusMarker.getLatLng();
                performRadiusSearch(center.lat, center.lng);
            }
        });

        // Distance unit change handler
        document.getElementById('distance-unit').addEventListener('change', function() {
            if (distancePointA && distancePointB) {
                const distanceKm = haversineDistance(distancePointA.lat, distancePointA.lon, distancePointB.lat, distancePointB.lon);
                const unit = this.value;
                let distance, unitLabel;

                if (unit === 'miles') {
                    distance = distanceKm / 1.60934;
                    unitLabel = 'miles';
                } else if (unit === 'nm') {
                    distance = distanceKm / 1.852;
                    unitLabel = 'nautical miles';
                } else {
                    distance = distanceKm;
                    unitLabel = 'kilometers';
                }

                document.getElementById('distance-result').innerHTML = `${distance.toFixed(2)} ${unitLabel}`;
            }
        });

        // Initialize
        console.log('Starting initialization...');
        initMap();
        loadData();
    </script>
</body>
</html>
